#!/bin/sh

readonly zenstates='/usr/local/src/Zenstates-Linux'
readonly script="${zenstates}/zenstates.py"
readonly url='https://github.com/r4m0n/ZenStates-Linux/'

check_zenstates()
{
  if [ ! -e "${zenstates}" ] || [ ! -d "${zenstates}" ]; then
    git clone "${url}" "${zenstates}" || {
      printf -- 'Failed to clone "%s" into "%s"\n' "${url}" "${zenstates}"
      printf -- 'Please re-run the script.\n'
      return 1
    }
  else
    if [ ! -e "${script}" ] || [ ! -x "${script}" ]; then
      printf -- 'Zenstates script could not be found at %s\n' "${script}"
      printf -- 'Please re-clone the repository.\n'
      return 1
    fi
  fi

  return 0
}

require()
{
  if ! command -v "$1" > /dev/null; then
    printf -- 'You must install "%s"\n' "$1"
    return 1
  fi

  return 0
}

require_python()
{
  require 'python3' || return 1
  return 0
}

require_git()
{
  require 'git' || return 1
  return 0
}

require_root()
{
  if [ "$(id -u)" -ne 0 ]; then
    printf -- 'You must be root.\n'
    return 1
  fi

  return 0
}

load_kernel_modules()
{
  modprobe -i msr || {
    printf -- 'Failed to load "msr" module\n'
    return 1
  }

  return 0
}

main()
{
  # Pre-req user
  require_root || return 1

  # Pre-req software
  require_git || return 1
  require_python || return 1

  # Pre-req script location
  check_zenstates || return 1

  # Run the script and disable c6
  load_kernel_modules || return 1

  python3 "${script}" --c6-disable || return 1
  return 0
}

main "$@" || exit 1
exit 0
